#!/usr/bin/env bash

set -e

dotfiles="${DOTFILES_HOME:-"$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"}"
config="${XDG_CONFIG_HOME:-"$HOME/.config"}"

link() {
    target="$1"
    from="$dotfiles/$target"
    to="$2"
    to_parent="$(dirname "$to")"

    if [ ! -d "$to_parent" ]; then
        mkdir -p "$to_parent"
    fi

    echo "Linking $target to $to"

    ln -fns "$from" "$to"
}

link_all() {
    target="$1"
    from="$dotfiles/$target"
    to="$2"

    if [ ! -d "$to" ]; then
        mkdir -p "$to"
    fi

    echo "Linking all in $target to $to"

    for f in "$from"/*; do
        name="$(basename "$f")"
        ln -fns "$f" "$to/$name"
    done
}

# Link common config
link_all bin "$HOME/.local/bin"
link fish "$config/fish"
link git "$config/git"
link_all gnupg "$HOME/.gnupg"
link npm "$config/npm"
link shell/profile "$HOME/.profile"
link shell/profile "$HOME/.bashrc"
link shell/profile "$HOME/.zshrc"
link ranger "$config/ranger"
link tig "$config/tig"
link tmux/tmux.conf "$HOME/.tmux.conf"
link vim "$HOME/.vim"

# Link host specific config
if [ "$(uname)" = Linux ]; then
    link sublime-merge "$config/sublime-merge/Packages/User"
    link sublime-text "$config/sublime-text-3/Packages/User"
    link sublime-text/plugins "$config/sublime-text-3/Packages/UserPlugins"
elif [ "$(uname)" = Darwin ]; then
    link_all mac/launch-agents "$HOME/Library/LaunchAgents"
    link_all mac/services "$HOME/Library/Services"
    link mac/xcode/themes "$HOME/Library/Developer/Xcode/UserData/FontAndColorThemes"
    link sublime-merge "$HOME/Library/Application Support/Sublime Merge/Packages/User"
    link sublime-text "$HOME/Library/Application Support/Sublime Text 3/Packages/User"
    link sublime-text/plugins "$HOME/Library/Application Support/Sublime Text 3/Packages/UserPlugins"
fi
