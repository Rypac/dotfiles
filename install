#!/usr/bin/env bash

set -e

dotfiles="${DOTFILES_HOME:-"$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"}"

link() {
    target="$1"
    origin="$dotfiles/$target"
    destination="$2"

    if [ -d "$origin" ]; then
        if [ ! -d "$destination" ]; then
            mkdir -p "$destination"
        fi

        echo "Linking $target/* to $destination"

        for f in "$origin"/*; do
            name="$(basename "$f")"
            ln -fns "$f" "$destination/$name"
        done
    else
        destination_parent="$(dirname "$destination")"

        if [ ! -d "$destination_parent" ]; then
            mkdir -p "$destination_parent"
        fi

        echo "Linking $target to $destination"

        ln -fns "$origin" "$destination"
    fi
}

# Source environment variables
. "$dotfiles/zsh/zshenv"

# Link common config
link bin "$XDG_BIN_HOME"
link git "$XDG_CONFIG_HOME/git"
link gnupg "$HOME/.gnupg"
link npm "$XDG_CONFIG_HOME/npm"
link ranger "$XDG_CONFIG_HOME/ranger"
link tig "$XDG_CONFIG_HOME/tig"
link tmux "$XDG_CONFIG_HOME/tmux"
link vim "$HOME/.vim"
link zsh/zshenv "$HOME/.zshenv"
link zsh/zshenv "$XDG_CONFIG_HOME/zsh/.zshenv"
link zsh/zprofile "$XDG_CONFIG_HOME/zsh/.zprofile"
link zsh/zshrc "$XDG_CONFIG_HOME/zsh/.zshrc"

# Link host specific config
if [ "$(uname)" = Linux ]; then
    link sublime-merge "$XDG_CONFIG_HOME/sublime-merge/Packages/User"
    link sublime-text "$XDG_CONFIG_HOME/sublime-text/Packages/User"
elif [ "$(uname)" = Darwin ]; then
    link mac/launch-agents "$HOME/Library/LaunchAgents"
    link mac/services "$HOME/Library/Services"
    link sublime-merge "$HOME/Library/Application Support/Sublime Merge/Packages/User"
    link sublime-text "$HOME/Library/Application Support/Sublime Text/Packages/User"
fi
