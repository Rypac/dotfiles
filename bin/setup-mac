#!/usr/bin/env bash

set -e

# Setup XDG environment variables
: "${DOTFILES_HOME:="$HOME/.dotfiles"}"

# Source environment variables
. "$DOTFILES_HOME/zsh/zshenv"
. "$DOTFILES_HOME/zsh/zprofile"

# Bootstrap required directories
mkdir -p "$XDG_BIN_HOME" "$XDG_CONFIG_HOME" "$XDG_DATA_HOME" "$XDG_CACHE_HOME" "$XDG_STATE_HOME"

# Install and update homebrew
if ! type brew > /dev/null 2>&1; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    brew update
    brew upgrade
fi

# Install packages
brew tap homebrew/bundle
brew bundle --file="$DOTFILES_HOME/mac/Brewfile"

# Set preferences
"$DOTFILES_HOME/mac/Preferences"

# Install configuration
"$DOTFILES_HOME/install"

# Create necessary directories and fix permissions
mkdir -p ~/.gnupg ~/.ssh
find ~/.gnupg ~/.ssh -type d -exec chmod 700 {} \;
find ~/.gnupg ~/.ssh -type f -exec chmod 600 {} \;

# Remove last login message from new terminal sessions
touch ~/.hushlogin
